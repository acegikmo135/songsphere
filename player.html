<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/logo.png">
    <title>Song Sphere</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-color-light: #f0f2f5;
            --text-color-light: #333;
            --primary-color-light: #6c5ce7;
            --card-bg-light: #fff;
            --border-color-light: #e0e0e0;
            --bg-color-dark: #000000;
            --text-color-dark: #e0e0e0;
            --primary-color-dark: #ff4757;
            --card-bg-dark: #151515;
            --border-color-dark: #3a3a5f;
            --gradient-start-rgb: 255, 0, 150;
            --gradient-mid-rgb: 0, 200, 255;
            --gradient-end-rgb: 150, 0, 255;
            --gradient-dark-start-rgb: 255, 71, 87;
            --gradient-dark-mid-rgb: 255, 140, 0;
            --gradient-dark-end-rgb: 255, 20, 147;
            
            /* NEW: Variables for slider fill and thumb colors */
            --progress-color-light: #585858;
            --progress-color-dark: #747474;
            --thumb-color-light: #000000;
            --thumb-color-dark: #afafaf;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            line-height: 1.6;
        }

        body.dark-theme {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        .player-container {
            width: 90%;
            max-width: 480px;
            height: 90vh;
            max-height: 900px;
            background-color: var(--card-bg-light);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 30px;
            text-align: center;
            position: relative;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            z-index: 1;
        }

        body.dark-theme .player-container {
            background-color: var(--card-bg-dark);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
        }

        .main-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            width: 100%;
            height: 100%;
            padding-top: 40px;
            padding-bottom: 20px;
            box-sizing: border-box;
        }
        
        .player-container:before{content:'';position:absolute;top:-3px;left:-3px;right:-3px;bottom:-3px;border-radius:23px;z-index:-1;opacity:1;filter:blur(5px);background:linear-gradient(90deg,rgb(var(--gradient-start-rgb)),rgb(var(--gradient-mid-rgb)),rgb(var(--gradient-end-rgb)),rgb(var(--gradient-mid-rgb)),rgb(var(--gradient-start-rgb)));background-size:200% 100%;animation:gradientBorderLight 4s linear infinite;-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude}body.dark-theme .player-container:before{background:linear-gradient(90deg,rgb(var(--gradient-dark-start-rgb)),rgb(var(--gradient-dark-mid-rgb)),rgb(var(--gradient-dark-end-rgb)),rgb(var(--gradient-dark-mid-rgb)),rgb(var(--gradient-dark-start-rgb)));animation:gradientBorderDark 4s linear infinite}@keyframes gradientBorderLight{0%{background-position:0 50%}100%{background-position:100% 50%}}@keyframes gradientBorderDark{0%{background-position:0 50%}100%{background-position:100% 50%}}.top-controls{position:absolute;top:25px;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:0 25px;width:100%;box-sizing:border-box;z-index:2}.back-button,.theme-toggle{background:0 0;border:none;font-size:1.8em;cursor:pointer;color:var(--text-color-light);transition:color .3s ease,transform .2s ease;outline:0;flex-shrink:0}body.dark-theme .back-button,body.dark-theme .theme-toggle{color:var(--text-color-dark)}.back-button:hover{transform:translateX(-5px) scale(1.05);color:var(--primary-color-light)}body.dark-theme .back-button:hover{color:var(--primary-color-dark)}.theme-toggle:hover{transform:scale(1.1);color:var(--primary-color-light)}body.dark-theme .theme-toggle:hover{color:var(--primary-color-dark)}.cover-image{width:clamp(180px,35vh,280px);height:clamp(180px,35vh,280px);border-radius:15px;object-fit:cover;box-shadow:0 10px 25px rgba(0,0,0,.2);transition:transform .3s ease,box-shadow .3s ease}.cover-image:hover{transform:scale(1.02);box-shadow:0 15px 35px rgba(0,0,0,.3)}.song-details h2{margin:0 0 5px;font-size:clamp(1.5em,4.5vh,2.4em);font-weight:700;color:var(--text-color-light);transition:color .3s ease}body.dark-theme .song-details h2{color:var(--text-color-dark)}.song-details p{margin:0;font-size:clamp(1em,2.5vh,1.3em);color:#888}.song-details .duration{font-size:clamp(.9em,2vh,1.1em);color:#555;font-weight:500}body.dark-theme .song-details .duration{color:#aaa}.player-controls-group{width:100%;display:flex;flex-direction:column;gap:clamp(15px,2vh,25px);align-items:center}.main-controls{display:flex;justify-content:center;align-items:center;gap:clamp(15px,3vw,25px);width:100%}.player-btn{background:var(--primary-color-light);color:#fff;border:none;width:clamp(40px,8vw,55px);height:clamp(40px,8vw,55px);border-radius:50%;font-size:clamp(1.4em,2.5vw,1.8em);display:flex;justify-content:center;align-items:center;cursor:pointer;transition:background-color .3s ease,transform .2s ease,box-shadow .3s ease;box-shadow:0 5px 15px rgba(0,0,0,.25);outline:0}body.dark-theme .player-btn{background:var(--primary-color-dark);box-shadow:0 5px 15px rgba(0,0,0,.4)}.player-btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.35);background-color:#5a4bda}body.dark-theme .player-btn:hover{background-color:#dc3e4e}.player-btn.play-pause{width:clamp(55px,11vw,70px);height:clamp(55px,11vw,70px);font-size:clamp(2em,3.5vw,2.5em)}.progress-bar-container{display:flex;align-items:center;width:100%;gap:10px}.current-time,.total-time{font-size:.9em;color:#777;min-width:45px;text-align:center;transition:color .3s ease}body.dark-theme .current-time,body.dark-theme .total-time{color:#ccc}

        /* --- Updated Slider Styles --- */
        .progress-bar {
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color-light);
            border-radius: 5px;
            outline: none;
            height: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        body.dark-theme .progress-bar {
            background: var(--border-color-dark);
        }

        /* Webkit (Chrome, Safari, Opera) */
        .progress-bar::-webkit-slider-runnable-track {
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, var(--progress-color-light) var(--progress-width, 0%), var(--border-color-light) var(--progress-width, 0%));
        }
        body.dark-theme .progress-bar::-webkit-slider-runnable-track {
            background: linear-gradient(to right, var(--progress-color-dark) var(--progress-width, 0%), var(--border-color-dark) var(--progress-width, 0%));
        }

        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: clamp(18px,3.5vh,22px);
            height: clamp(18px,3.5vh,22px);
            background: var(--thumb-color-light);
            border-radius: 50%;
            cursor: grab;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: -6px;
        }
        body.dark-theme .progress-bar::-webkit-slider-thumb {
            background: var(--thumb-color-dark);
        }
        .progress-bar::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            cursor: grabbing;
        }

        /* Moz (Firefox) */
        .progress-bar::-moz-range-track {
            height: 10px;
            border-radius: 5px;
            background: var(--border-color-light);
        }
        body.dark-theme .progress-bar::-moz-range-track {
            background: var(--border-color-dark);
        }
        
        .progress-bar::-moz-range-progress {
            background: var(--progress-color-light);
            height: 10px;
            border-radius: 5px;
        }
        body.dark-theme .progress-bar::-moz-range-progress {
            background: var(--progress-color-dark);
        }
        
        .progress-bar::-moz-range-thumb {
            width: clamp(18px,3.5vh,22px);
            height: clamp(18px,3.5vh,22px);
            background: var(--thumb-color-light);
            border-radius: 50%;
            cursor: grab;
            border: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        body.dark-theme .progress-bar::-moz-range-thumb {
            background: var(--thumb-color-dark);
        }
        .progress-bar::-moz-range-thumb:hover {
            transform: scale(1.1);
            cursor: grabbing;
        }
        
        .progress-bar {
            flex-grow: 1;
            height: 10px;
        }
        .download-btn{background-color:var(--primary-color-light);color:#fff;border:none;padding:clamp(10px,2vh,12px) clamp(20px,4vw,25px);border-radius:10px;cursor:pointer;font-size:clamp(.9em,2vh,1.1em);display:flex;align-items:center;gap:10px;transition:background-color .3s ease,transform .2s ease,box-shadow .3s ease;position:relative;overflow:hidden;z-index:2}body.dark-theme .download-btn{background-color:var(--primary-color-dark)}.download-btn:hover{background-color:#5a4bda;transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.2)}body.dark-theme .download-btn:hover{background-color:#dc3e4e}.download-btn.downloading{cursor:not-allowed}.download-btn.downloading:before{content:'';position:absolute;top:0;left:0;width:var(--download-progress-width,0);height:100%;background-color:rgba(255,255,255,.4);border-radius:8px;transition:width .1s linear;z-index:1}.download-btn.downloading .fa-download{display:none}.download-btn.downloading .fa-spinner{display:inline-block;animation:spin 1s linear infinite}.download-btn .fa-spinner{display:none}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="player-container">
        <div class="top-controls">
            <button class="back-button" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button id="theme-toggle" class="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="main-content-wrapper">
            <img id="cover-image" class="cover-image" src="" alt="Song Cover">
            
            <div class="song-details">
                <h2 id="song-title"></h2>
                <p id="song-artist"></p>
                <p id="song-duration" class="duration"></p>
            </div>
    
            <div class="player-controls-group">
                <div class="main-controls">
                    <button id="prev-btn" class="player-btn"><i class="fas fa-backward"></i></button>
                    <button id="play-pause-btn" class="player-btn play-pause"><i class="fas fa-play"></i></button>
                    <button id="next-btn" class="player-btn"><i class="fas fa-forward"></i></button>
                </div>
                <div class="progress-bar-container">
                    <div id="current-time" class="current-time">0:00</div>
                    <input type="range" id="progress-bar" class="progress-bar" value="0" min="0" max="100">
                    <div id="total-time" class="total-time">0:00</div>
                </div>
            </div>
            
            <button id="download-btn" class="download-btn">
                <i class="fas fa-download"></i>
                <i class="fas fa-spinner fa-spin"></i>
                <span>Download</span>
            </button>
        </div>
        
        <audio id="audio-source" preload="metadata"></audio>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const themeToggleBtn = document.getElementById('theme-toggle');
            const body = document.body;
            const coverImage = document.getElementById('cover-image');
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            const songDurationDisplay = document.getElementById('song-duration');
            const audio = document.getElementById('audio-source');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeSpan = document.getElementById('current-time');
            const totalTimeSpan = document.getElementById('total-time');
            const downloadBtn = document.getElementById('download-btn');
            
            let currentSongIndex = 0;
            let isDraggingProgressBar = false;
            let musicData = [];

            // --- Load Data From Session Storage ---
            try {
                const storedData = sessionStorage.getItem('musicData');
                if (storedData) {
                    musicData = JSON.parse(storedData);
                } else {
                    // Fallback if sessionStorage is empty
                    window.location.href = 'index.html'; 
                    return;
                }
            } catch (e) {
                console.error("Failed to load music data. Redirecting.", e);
                window.location.href = 'index.html';
                return;
            }

            themeToggleBtn.addEventListener('click', () => {
                body.classList.toggle('dark-theme');
                themeToggleBtn.querySelector('i').className = body.classList.contains('dark-theme') ? 'fas fa-sun' : 'fas fa-moon';
            });

            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "0:00";
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            }

            function loadSong(index) {
                if (index < 0 || index >= musicData.length) return;
                currentSongIndex = index;
                const song = musicData[currentSongIndex];

                coverImage.src = song.cover;
                songTitle.textContent = song.title;
                songArtist.textContent = song.artist || ' ';
                songDurationDisplay.textContent = song.duration || 'N/A';
                totalTimeSpan.textContent = song.duration || '0:00';
                audio.src = song.src;

                playPauseBtn.querySelector('i').className = 'fas fa-play';
                progressBar.value = 0;
                updateProgressBarFill();
                currentTimeSpan.textContent = '0:00';
                audio.pause();
            }

            function updateProgressBarFill() {
                const value = progressBar.value;
                progressBar.style.setProperty('--progress-width', `${value}%`);
            }

            playPauseBtn.addEventListener('click', () => {
                const isPaused = audio.paused;
                if (isPaused) {
                    audio.play();
                    playPauseBtn.querySelector('i').className = 'fas fa-pause';
                } else {
                    audio.pause();
                    playPauseBtn.querySelector('i').className = 'fas fa-play';
                }
            });

            audio.addEventListener('timeupdate', () => {
                if (!isDraggingProgressBar && audio.duration) {
                    progressBar.value = (audio.currentTime / audio.duration) * 100;
                    updateProgressBarFill();
                    currentTimeSpan.textContent = formatTime(audio.currentTime);
                }
            });

            audio.addEventListener('loadedmetadata', () => {
                totalTimeSpan.textContent = formatTime(audio.duration);
            });

            audio.addEventListener('ended', playNextSong);

            progressBar.addEventListener('mousedown', () => { isDraggingProgressBar = true; });
            progressBar.addEventListener('mouseup', () => { isDraggingProgressBar = false; });
            progressBar.addEventListener('input', () => {
                if(audio.duration) audio.currentTime = (progressBar.value / 100) * audio.duration;
                updateProgressBarFill();
            });

            function playNextSong() {
                currentSongIndex = (currentSongIndex + 1) % musicData.length;
                loadSong(currentSongIndex);
                audio.play();
                playPauseBtn.querySelector('i').className = 'fas fa-pause';
            }

            function playPrevSong() {
                currentSongIndex = (currentSongIndex - 1 + musicData.length) % musicData.length;
                loadSong(currentSongIndex);
                audio.play();
                playPauseBtn.querySelector('i').className = 'fas fa-pause';
            }

            nextBtn.addEventListener('click', playNextSong);
            prevBtn.addEventListener('click', playPrevSong);

            // --- Download Button Functionality ---
            downloadBtn.addEventListener('click', () => {
                const song = musicData[currentSongIndex];
                if (!song || !song.src) {
                    console.error("No song or source available to download.");
                    return;
                }

                downloadBtn.classList.add('downloading');
                downloadBtn.disabled = true;

                fetch(song.src)
                    .then(response => {
                        const totalSize = response.headers.get('content-length');
                        let downloadedSize = 0;

                        const reader = response.body.getReader();

                        return new ReadableStream({
                            start(controller) {
                                function push() {
                                    reader.read().then(({ done, value }) => {
                                        if (done) {
                                            controller.close();
                                            return;
                                        }
                                        downloadedSize += value.length;
                                        const progress = (totalSize) ? (downloadedSize / totalSize) * 100 : 0;
                                        downloadBtn.style.setProperty('--download-progress-width', `${progress}%`);
                                        controller.enqueue(value);
                                        push();
                                    }).catch(error => {
                                        console.error('Download error:', error);
                                        controller.error(error);
                                    });
                                }
                                push();
                            }
                        });
                    })
                    .then(stream => new Response(stream))
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `${song.title}.mp3`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(error => {
                        console.error('Download failed:', error);
                        alert('Download failed. Please try again.');
                    })
                    .finally(() => {
                        downloadBtn.classList.remove('downloading');
                        downloadBtn.disabled = false;
                        downloadBtn.style.setProperty('--download-progress-width', '0%');
                    });
            });

            // --- Initialization ---
            const urlParams = new URLSearchParams(window.location.search);
            const initialSongIndex = parseInt(urlParams.get('songIndex'), 10) || 0;
            loadSong(initialSongIndex);
            
            // Re-initialize progress bar fill
            updateProgressBarFill();
        });
    </script>
</body>
</html>
